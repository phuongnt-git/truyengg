<!DOCTYPE html>
<html lang="vi" translate="no"
      xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head">
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
  <meta content="notranslate" name="google">
  <title>Mới Cập Nhật - TruyenGG</title>
  <link href="https://st.truyengg.net/template/frontend/styles/style.css?v=1.9.4" rel="stylesheet" type="text/css">
  <link href="https://st.truyengg.net/template/frontend/styles/dark_style.css?v=1.3.4" rel="stylesheet" type="text/css">
  <link href="https://st.truyengg.net/template/frontend/icon/css/font-awesome.min.css?v=1.2.3" rel="stylesheet"
        type="text/css">
</head>
<body class="dark-style" th:replace="fragments/header :: header-body">
<div class="container mt15 h1-home d-flex align-items-center">
  <i class="bi bi-cloud-arrow-down-fill me-2"></i>
  <h1 class="fw600 mb-0">Mới Cập Nhật</h1>
</div>
<div class="container container-background">
  <section>
    <div class="row list_item_home" id="comics-list">
      <div class="col-12 text-center">
        <div class="spinner-border" role="status">
          <span class="sr-only">Đang tải...</span>
        </div>
      </div>
    </div>
    <div class="has-text-centered mt-3" id="pagination-container">
      <!-- Pagination will be loaded here -->
    </div>
  </section>
</div>
<footer th:replace="fragments/footer :: footer"></footer>
<script th:src="@{/js/jquery.lazy.min.js}"></script>
<script th:src="@{/js/app.js}"></script>
<script th:src="@{/js/api.js}"></script>
<script th:src="@{/js/utils.js}"></script>
<script th:src="@{/js/comics.js}"></script>
<script>
  let currentPage = 0;
  const pageSize = 24;

  $(document).ready(function () {
    const urlParams = new URLSearchParams(window.location.search);
    currentPage = parseInt(urlParams.get('page')) || 0;

    loadComics();
  });

  function loadComics() {
    ComicsModule.loadComics('/lists/new-comics', '#comics-list', {
      page: currentPage,
      size: pageSize,
      onLoad: function (comics, data) {
        renderPagination(data);

        // Initialize lazy loading
        if (typeof $.fn.lazy !== 'undefined') {
          $('#comics-list .lazy-image').lazy({
            effect: 'fadeIn',
            effectTime: 300,
            threshold: 0
          });
        }
      },
      onError: function (xhr) {
        $('#comics-list').html('<p class="text-center">Không thể tải danh sách truyện</p>');
      }
    });
  }

  function renderPagination(data) {
    const totalPages = data.totalPages || 0;
    const $container = $('#pagination-container');
    $container.empty();

    if (totalPages <= 1) return;

    let paginationHtml = '<div class="pagination">';

    // Previous button
    if (currentPage > 0) {
      paginationHtml += `<a href="?page=${currentPage - 1}" class="page-item">‹</a>`;
    }

    // Page numbers
    const maxPages = 5;
    let startPage = Math.max(0, currentPage - Math.floor(maxPages / 2));
    let endPage = Math.min(totalPages - 1, startPage + maxPages - 1);

    if (endPage - startPage < maxPages - 1) {
      startPage = Math.max(0, endPage - maxPages + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
      if (i === currentPage) {
        paginationHtml += `<a href="javascript:void(0)" class="page-item active">${i + 1}</a>`;
      } else {
        paginationHtml += `<a href="?page=${i}" class="page-item">${i + 1}</a>`;
      }
    }

    // Next button
    if (currentPage < totalPages - 1) {
      paginationHtml += `<a href="?page=${currentPage + 1}" class="page-item">›</a>`;
    }

    paginationHtml += '</div>';
    $container.html(paginationHtml);
  }
</script>
</body>
</html>
