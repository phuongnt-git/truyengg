<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruyenGG - Chi tiết Crawl Job</title>
    <link rel="stylesheet" th:href="@{/voler/css/bootstrap.css}">
    <link rel="stylesheet" th:href="@{/voler/vendors/perfect-scrollbar/perfect-scrollbar.css}">
    <link rel="stylesheet" th:href="@{/voler/css/app.css}">
    <link rel="shortcut icon" th:href="@{/voler/images/favicon.png}" type="image/png">
</head>
<body>
    <div id="app">
        <div id="sidebar" class='active'>
            <th:block th:replace="~{admin/layouts/sidebar :: sidebar}"></th:block>
        </div>
        <div id="main">
            <nav class="navbar navbar-header navbar-expand navbar-light">
                <a class="sidebar-toggler" href="#"><span class="navbar-toggler-icon"></span></a>
                <button class="btn navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                    aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav d-flex align-items-center navbar-light ms-auto">
                        <li class="dropdown">
                            <a href="#" data-bs-toggle="dropdown" class="nav-link dropdown-toggle nav-link-lg nav-link-user">
                                <div class="avatar me-1">
                                    <img th:src="@{/voler/images/avatar/avatar-s-1.png}" alt="Avatar" srcset="">
                                </div>
                                <div class="d-none d-md-block d-lg-inline-block">
                                    <span sec:authentication="name">Admin</span>
                                </div>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end">
                                <a class="dropdown-item" th:href="@{/}">
                                    <i data-feather="home"></i> Home
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="javascript:void(0);" onclick="logout(); return false;">
                                    <i data-feather="log-out"></i> Logout
                                </a>
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
            <div class="main-content container-fluid">
                <th:block th:replace="~{admin/fragments/page-header :: page-header('Chi tiết Crawl Job', 'Xem chi tiết và quản lý crawl job')}"></th:block>
                <section class="section">
                    <!-- Loading indicator -->
                    <div class="text-center" id="loadingIndicator" style="padding: 50px;">
                        <i data-feather="loader"></i>
                        <p>Đang tải thông tin job...</p>
                    </div>

                    <!-- Job Detail Content -->
                    <div id="jobDetailContent" style="display: none;">
                        <!-- Job Info Card -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h4 class="card-title mb-0"><i data-feather="info"></i> Thông tin Job</h4>
                                <a class="btn btn-sm btn-secondary" th:href="@{/admin/jobs}">
                                    <i data-feather="arrow-left"></i> Quay lại
                                </a>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><span class="fw-bold">Job ID:</span> <span id="jobId"></span></p>
                                        <p><span class="fw-bold">Trạng thái:</span> <span id="jobStatus"></span></p>
                                        <p><span class="fw-bold">Nguồn:</span> <span id="jobSource"></span></p>
                                        <p><span class="fw-bold">URL:</span> <a href="#" id="jobUrl" target="_blank"></a></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><span class="fw-bold">Người tạo:</span> <span id="jobCreatedBy"></span></p>
                                        <p><span class="fw-bold">Thời gian bắt đầu:</span> <span id="jobStartTime"></span></p>
                                        <p><span class="fw-bold">Thời gian kết thúc:</span> <span id="jobEndTime"></span></p>
                                        <p><span class="fw-bold">Tổng số chương:</span> <span id="jobTotalChapters"></span></p>
                                    </div>
                                </div>
                                <div id="checkpointInfo" style="display: none; margin-top: 20px; padding: 15px; background-color: #fff3cd; border-radius: 4px;">
                                    <h5><i data-feather="pause-circle"></i> Thông tin Checkpoint</h5>
                                    <p><span class="fw-bold">Chương hiện tại:</span> <span id="checkpointChapterIndex"></span></p>
                                    <p><span class="fw-bold">Thời gian pause:</span> <span id="checkpointPausedAt"></span></p>
                                    <p><span class="fw-bold">Lý do pause:</span> <span id="checkpointReason"></span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Statistics Cards -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card card-statistic text-center">
                                    <div class="card-body">
                                        <div class="stat-icon text-primary"><i data-feather="activity"></i></div>
                                        <div class="stat-value" id="downloadSpeed">0</div>
                                        <div class="stat-label">Tốc độ tải</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-statistic text-center">
                                    <div class="card-body">
                                        <div class="stat-icon text-warning"><i data-feather="clock"></i></div>
                                        <div class="stat-value" id="totalDownloadTime">-</div>
                                        <div class="stat-label">Thời gian tải</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-statistic text-center">
                                    <div class="card-body">
                                        <div class="stat-icon text-success"><i data-feather="hard-drive"></i></div>
                                        <div class="stat-value" id="fileSize">0 MB</div>
                                        <div class="stat-label">Kích thước file</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-statistic text-center">
                                    <div class="card-body">
                                        <div class="stat-icon text-info"><i data-feather="wifi"></i></div>
                                        <div class="stat-value" id="networkStats">0</div>
                                        <div class="stat-label">Requests / Errors</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Retry Statistics Card -->
                        <div class="card mb-3" id="retryStatsCard" style="display: none;">
                            <div class="card-header">
                                <h4 class="card-title"><i data-feather="alert-triangle"></i> Thống kê Retry</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <p><span class="fw-bold">Max retry count:</span> <span id="maxRetryCount">0</span></p>
                                    </div>
                                    <div class="col-md-3">
                                        <p><span class="fw-bold">Avg retry count:</span> <span id="avgRetryCount">0</span></p>
                                    </div>
                                    <div class="col-md-3">
                                        <p><span class="fw-bold">Chapters với retry:</span> <span id="chaptersWithRetry">0</span></p>
                                    </div>
                                    <div class="col-md-3">
                                        <p><span class="fw-bold">Failed chapters:</span> <span id="failedChaptersCount">0</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Chapter Details Card -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h4 class="card-title mb-0"><i data-feather="list"></i> Chi tiết Chapters</h4>
                                <button class="btn btn-sm btn-secondary" id="btnFilterChapters">
                                    <i data-feather="filter"></i> Lọc
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover" id="chaptersTable">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Tên chương</th>
                                                <th>Trạng thái</th>
                                                <th>Tiến độ</th>
                                                <th>Hình ảnh</th>
                                                <th>Kích thước</th>
                                                <th>Thời gian</th>
                                                <th>Tốc độ</th>
                                                <th>Retry</th>
                                                <th>Lỗi</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody id="chaptersTableBody">
                                            <tr>
                                                <td colspan="11" class="text-center text-muted">Đang tải...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Card -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h4 class="card-title"><i data-feather="trending-up"></i> Biểu đồ tiến độ</h4>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="progressChart"></canvas>
                                </div>
                                <div class="chart-container">
                                    <canvas id="speedChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Card -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h4 class="card-title mb-0"><i data-feather="activity"></i> Tiến độ</h4>
                                <span class="badge bg-secondary" id="wsConnectionStatus"><i data-feather="circle"></i> Đã ngắt kết nối</span>
                            </div>
                            <div class="card-body">
                                <!-- Chapter Progress -->
                                <div class="mb-3">
                                    <label>Tiến độ chương: <span id="chapterProgressText">0 / 0 (0%)</span></label>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                             id="chapterProgressBar" role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                </div>

                                <!-- Image Progress -->
                                <div class="mb-3">
                                    <label>Tiến độ hình ảnh: <span id="imageProgressText">0 / 0 (0%)</span></label>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                             id="imageProgressBar" role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                </div>

                                <!-- Elapsed Time -->
                                <div class="mb-3">
                                    <p><span class="fw-bold">Thời gian đã trôi qua:</span> <span id="elapsedTime">0 giây</span></p>
                                </div>

                                <!-- Current Message -->
                                <div class="mb-3">
                                    <p><span class="fw-bold">Thông báo hiện tại:</span></p>
                                    <div class="alert alert-info" id="currentMessage" style="margin-bottom: 0;">Đang khởi tạo...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Messages/Logs Card -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h4 class="card-title"><i data-feather="file-text"></i> Nhật ký</h4>
                            </div>
                            <div class="card-body">
                                <div id="messagesScrollBox">
                                    <div class="text-muted text-center">Chưa có thông báo nào...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions Card -->
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title"><i data-feather="settings"></i> Thao tác</h4>
                            </div>
                            <div class="card-body">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-warning" id="btnPause" style="display: none;">
                                        <i data-feather="pause"></i> Tạm dừng
                                    </button>
                                    <button class="btn btn-success" id="btnResume" style="display: none;">
                                        <i data-feather="play"></i> Tiếp tục
                                    </button>
                                    <button class="btn btn-danger" id="btnCancel" style="display: none;">
                                        <i data-feather="x"></i> Hủy
                                    </button>
                                    <button class="btn btn-primary" id="btnRetry" style="display: none;">
                                        <i data-feather="refresh-cw"></i> Retry
                                    </button>
                                    <a class="btn btn-secondary" th:href="@{/admin/jobs}">
                                        <i data-feather="arrow-left"></i> Quay lại danh sách
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <footer>
                <div class="footer clearfix mb-0 text-muted">
                    <div class="float-start">
                        <p>2024 &copy; <a th:href="@{/}">TruyenGG</a></p>
                    </div>
                    <div class="float-end">
                        <p>Crafted with <span class='text-danger'><i data-feather="heart"></i></span> by TruyenGG Team</p>
                    </div>
                </div>
            </footer>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:src="@{/voler/js/feather-icons/feather.min.js}"></script>
    <script th:src="@{/voler/vendors/perfect-scrollbar/perfect-scrollbar.min.js}"></script>
    <script th:src="@{/voler/js/app.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script th:src="@{/js/admin-auth.js}"></script>
    <script th:src="@{/js/admin/voler-init.js}"></script>
    <script th:src="@{/js/api.js}"></script>
    <script th:src="@{/js/admin/crawl-detail.js}"></script>
    <script th:src="@{/voler/js/main.js}"></script>
</body>
</html>
